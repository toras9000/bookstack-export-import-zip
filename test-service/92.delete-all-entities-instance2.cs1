#!/usr/bin/env -S dotnet run --file
#:package BookStackApiClient@25.12.0-lib.0
#:package Kokuban@0.2.0
#:package Lestaly.General@0.114.0
#:package RefFile@0.2.0
#:property PublishAot=false
using BookStackApiClient.Utility;
using Kokuban;
using Lestaly;
[assembly: RefFile(".settings.cs1")]

return await Paved.ProceedAsync(noPause: args.RoughContains("--no-pause"), async () =>
{
    var settings = new Settings(ThisSource.Directory());
    var instance = settings.Instance2;

    // Prepare console
    using var signal = new SignalCancellationPeriod();

    // Show info
    Console.WriteLine($"Delete all books in BookStack.");
    Console.WriteLine($"BookStack Service URL : {instance.BookStack.Url}");

    // Create client and helper
    var apiEndpoint = instance.BookStack.ApiEndpoint;
    var apiToken = instance.BookStack.ApiTokenId;
    var apiSecret = instance.BookStack.ApiTokenSecret;
    using var helper = new BookStackClientHelper(apiEndpoint, apiToken, apiSecret, signal.Token);
    helper.LimitHandler += (args) =>
    {
        Console.WriteLine(Chalk.Yellow[$"Caught in API call rate limitation. Rate limit: {args.Exception.RequestsPerMin} [per minute], {args.Exception.RetryAfter} seconds to lift the limit."]);
        Console.WriteLine(Chalk.Yellow[$"It will automatically retry after a period of time has elapsed."]);
        Console.WriteLine(Chalk.Yellow[$"[Waiting...]"]);
        return ValueTask.CompletedTask;
    };

    // Delete image gallery images
    Console.WriteLine($"Delete Gallery Images");
    while (true)
    {
        // Get a list of images
        var images = await helper.Try((c, t) => c.ListImagesAsync(new(count: 100), t));
        if (images.data.Length <= 0) break;

        // Delete each image
        foreach (var image in images.data)
        {
            Console.WriteLine($"..  Delete Image [{image.id}] {Chalk.Green[image.name]}");
            await helper.Try((c, t) => c.DeleteImageAsync(image.id, t));
        }
    }

    // Delete Books
    Console.WriteLine($"Delete Books");
    while (true)
    {
        // Get a list of books
        var books = await helper.Try((c, t) => c.ListBooksAsync(new(count: 500), t));
        if (books.data.Length <= 0) break;

        // Delete each book
        foreach (var book in books.data)
        {
            Console.WriteLine($"Delete [{book.id}] {Chalk.Green[book.name]}");
            await helper.Try((c, t) => c.DeleteBookAsync(book.id, t));
        }
    }

    // Delete Shelves
    Console.WriteLine($"Delete Shelves");
    while (true)
    {
        // Get a list of shelves
        var shelves = await helper.Try((c, t) => c.ListShelvesAsync(new(count: 500), t));
        if (shelves.data.Length <= 0) break;

        // Delete each shelf
        foreach (var shelf in shelves.data)
        {
            Console.WriteLine($"Delete [{shelf.id}] {Chalk.Green[shelf.name]}");
            await helper.Try((c, t) => c.DeleteShelfAsync(shelf.id, t));
        }
    }

    // Empty the trash
    Console.WriteLine($"Destroy RecycleBin");
    while (true)
    {
        // Get a list of books
        var recycles = await helper.Try((c, t) => c.ListRecycleBinAsync(new(count: 500), t));
        if (recycles.data.Length <= 0) break;

        // Delete Trash Items
        foreach (var recycle in recycles.data)
        {
            Console.WriteLine($"Destroy [{recycle.id}]");
            await helper.Try((c, t) => c.DestroyRecycleItemAsync(recycle.id, t));
        }
    }

    Console.WriteLine($"Completed");
});

